/*
 * Copyright 2024 Frans Jacobs.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package jcs.commandStation.marklin.cs.can.parser;

import jcs.commandStation.events.AccessoryEvent;
import jcs.commandStation.marklin.cs.can.CanMessage;
import jcs.entities.AccessoryBean;
import org.tinylog.Logger;

public class AccessoryMessage {

  private AccessoryMessage() {

  }

  public static AccessoryEvent parse(CanMessage message) {
    if (message == null) {
      return null;
    }
    CanMessage msg;
    if (message.isResponseMessage()) {
      msg = message.getResponse();
    } else {
      msg = message;
    }

    int cmd = msg.getCommand();
    int dlc = msg.getDlc();
    byte[] data = msg.getData();

    if (CanMessage.ACCESSORY_SWITCHING_RESP == cmd || CanMessage.ACCESSORY_SWITCHING == cmd) {
      byte[] addressData = new byte[]{data[2], data[3]};
      int address = CanMessage.toInt(addressData);
      String protocol;
      //CS is zero based
      if (address >= CanMessage.DCC_ACCESSORY_OFFSET) {
        protocol = "dcc";
        address = address - CanMessage.DCC_ACCESSORY_OFFSET + 1;
      } else {
        protocol = "mm";
        address = address + 1;
        address = address - CanMessage.MM_ACCESSORY_OFFSET;
      }

      int position = data[4];
      int power = data[5];

      String id = Integer.toString(address);
      AccessoryBean accessoryBean = new AccessoryBean(id, address, null, null, null, position, null, protocol, null, CanMessage.MARKLIN_COMMANDSTATION_ID);

      if (CanMessage.DLC_8 == dlc) {
        int switchTime = CanMessage.toInt(new byte[]{data[6], data[7]});
        switchTime = switchTime * 10;
        accessoryBean.setSwitchTime(switchTime);
      }

      return new AccessoryEvent(accessoryBean, (power > 0));
    } else {
      Logger.warn("Can't parse message, not an Accessory Message! " + message);
      return null;
    }
  }

}

//W 55 3 way green 
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x00 0x00 0x00
// 0x3000 tot 0x33FF accessory MM1,2 Zubehörartikeldecoder (40 kHz, 320 & 1024 Adressen)
// 0x3800 tot  0x3BFF DCC-Zubehörartikel
// 0x3C00 tot  0x3FFF DCC-Zubehörartikel
// dus  12343 - 12288 = 55
// 0x01 stellung groen
// 0x00 strom
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x00 0x00 0x00
// address = 12342 - 12288 = 54
// 0x01 stelluBit 0,1: Stellung:
//00: Aus, Rund, Rot, Rechts, HP0
//01: Ein, Grün, Gerade, HP1
//10: Gelb, Links, HP2
//11: Weis, SH0ng
// 
//tussen aan en uit zit ~220 ms
// W 55 3 way red left
//TRACE	2025-11-11 21:03:13.977 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x01 0x00 0x00
//TRACE	2025-11-11 21:03:14.173 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x00 0x00 0x00
// 55 groen
//TRACE	2025-11-11 21:03:14.183 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x00 0x01 0x00 0x00
//TRACE	2025-11-11 21:03:14.385 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x00 0x00 0x00 0x00
// 55 groen 54  rood
//W 55 3 way green
//TRACE	2025-11-11 21:04:25.489 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x01 0x00 0x00
//TRACE	2025-11-11 21:04:25.711 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x00 0x00 0x00
//TRACE	2025-11-11 21:04:25.714 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x01 0x00 0x00
//TRACE	2025-11-11 21:04:25.937 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x00 0x00 0x00
// 55 groon 54 groen
//W 55 3 way red right
//TRACE	2025-11-11 21:05:03.864 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x01 0x00 0x00
//TRACE	2025-11-11 21:05:04.088 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x00 0x00 0x00
//TRACE	2025-11-11 21:05:04.093 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x00 0x01 0x00 0x00
//TRACE	2025-11-11 21:05:04.315 [CS-EVENT-MESSAGE-HANDLER] MarklinCentralStationImpl$EventMessageHandler.run(): AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x00 0x00 0x00 0x00
// 54 groen 55 rood  // adres os 0 based du + 1!
// Recht door
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x00 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x00 0x00 0x00
// Links rood
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x01 0x00 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x00 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x00 0x00 0x00 0x00
//Rechts rood
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x36 0x01 0x00 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x00 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x37 0x00 0x00 0x00 0x00
//wissel 1 recht
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x00 0x01 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x00 0x01 0x00 0x00 0x00
//
//wissel 1 rood
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x00 0x00 0x01 0x00 0x00
//AccessorySwitching RX: 0x00 0x16 0x37 0x7e 0x06 0x00 0x00 0x30 0x00 0x00 0x00 0x00 0x00
